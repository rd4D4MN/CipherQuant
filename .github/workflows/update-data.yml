name: Update Finance Data

on:
  workflow_dispatch:  # Allows manual trigger

jobs:
  update-database:
    runs-on: self-hosted  # Use your local runner instead of GitHub's cloud servers

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Set Up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.9'

      - name: Install Dependencies
        run: pip install yfinance psycopg2-binary python-dotenv

      - name: Load Environment Variables
        run: |
          set -o allexport
          source .env
          set +o allexport
        shell: bash

      - name: Test Local Database Connection
        run: |
          python -c "
          import psycopg2
          from dotenv import load_dotenv
          import os

          # Load environment variables from .env
          load_dotenv()

          try:
              conn = psycopg2.connect(
                  host=os.getenv('DB_HOST'),
                  port=os.getenv('DB_PORT'),
                  user=os.getenv('DB_USER'),
                  password=os.getenv('DB_PASSWORD'),
                  dbname=os.getenv('DB_NAME')
              )
              print('✅ Successfully connected to local PostgreSQL.')
              conn.close()
          except Exception as e:
              print(f'❌ Failed to connect: {e}')
              exit(1)
          "
